{
 "name": "Item Tracking Report",
 "docstatus": 0,
 "report_name": "Item Tracking Report",
 "ref_doctype": "Item",
 "reference_report": null,
 "is_standard": "Yes",
 "module": "Stock",
 "report_type": "Script Report",
 "letter_head": "SurgiShop",
 "add_total_row": 0,
 "disabled": 0,
 "prepared_report": 0,
 "add_translate_data": 0,
 "timeout": 0,
 "query": null,
 "report_script": "def execute(filters=None):\r\n    # ------------------------------\r\n    # Define Columns\r\n    # ------------------------------\r\n    columns = [\r\n        {\"fieldname\": \"row_type\", \"label\": \"Type\", \"fieldtype\": \"Data\", \"width\": 120},\r\n        {\"fieldname\": \"date\", \"label\": \"Date\", \"fieldtype\": \"Date\", \"width\": 100},\r\n        {\"fieldname\": \"document\", \"label\": \"Document\", \"fieldtype\": \"Data\", \"width\": 150},\r\n        {\"fieldname\": \"qty\", \"label\": \"Qty\", \"fieldtype\": \"Float\", \"width\": 80},\r\n        {\"fieldname\": \"party\", \"label\": \"Supplier/Customer\", \"fieldtype\": \"Data\", \"width\": 180},\r\n        {\"fieldname\": \"reference\", \"label\": \"Invoice/PO #\", \"fieldtype\": \"Data\", \"width\": 150},\r\n        {\"fieldname\": \"stock\", \"label\": \"Stock\", \"fieldtype\": \"Float\", \"width\": 80},\r\n        {\"fieldname\": \"on_quote\", \"label\": \"On Quote\", \"fieldtype\": \"Float\", \"width\": 80},\r\n        {\"fieldname\": \"on_so\", \"label\": \"On Sales Order\", \"fieldtype\": \"Float\", \"width\": 100},\r\n        {\"fieldname\": \"notes\", \"label\": \"Notes\", \"fieldtype\": \"Data\", \"width\": 200},\r\n    ]\r\n\r\n    data = []\r\n\r\n    # ------------------------------\r\n    # Helper function for empty rows\r\n    # ------------------------------\r\n    def empty_row():\r\n        return {\r\n            \"row_type\": \"\",\r\n            \"date\": \"\",\r\n            \"document\": \"\",\r\n            \"qty\": \"\",\r\n            \"party\": \"\",\r\n            \"reference\": \"\",\r\n            \"stock\": \"\",\r\n            \"on_quote\": \"\",\r\n            \"on_so\": \"\",\r\n            \"notes\": \"\"\r\n        }\r\n\r\n    # ------------------------------\r\n    # Validate filter\r\n    # ------------------------------\r\n    if not filters or not filters.get(\"item_code\"):\r\n        return columns, data\r\n\r\n    item_code = filters.get(\"item_code\")\r\n\r\n    item_data = frappe.db.sql(\r\n        \"SELECT item_code, item_name FROM `tabItem` WHERE item_code = %s\",\r\n        (item_code,),\r\n        as_dict=True\r\n    )\r\n\r\n    if not item_data:\r\n        return columns, data\r\n\r\n    item = item_data[0]\r\n\r\n    # ------------------------------\r\n    # Calculate stock / quote / SO\r\n    # ------------------------------\r\n    stock_qty = frappe.db.sql(\r\n        \"SELECT COALESCE(SUM(actual_qty),0) FROM `tabBin` WHERE item_code = %s\",\r\n        (item_code,)\r\n    )[0][0]\r\n\r\n    quote_qty = frappe.db.sql(\r\n        \"\"\"\r\n        SELECT COALESCE(SUM(qi.qty),0)\r\n        FROM `tabQuotation Item` qi\r\n        INNER JOIN `tabQuotation` q ON q.name = qi.parent\r\n        WHERE qi.item_code = %s AND q.docstatus = 0 AND q.status != 'Lost'\r\n        \"\"\",\r\n        (item_code,)\r\n    )[0][0]\r\n\r\n    so_qty = frappe.db.sql(\r\n        \"\"\"\r\n        SELECT COALESCE(SUM(soi.qty - soi.delivered_qty),0)\r\n        FROM `tabSales Order Item` soi\r\n        INNER JOIN `tabSales Order` so ON so.name = soi.parent\r\n        WHERE soi.item_code = %s\r\n          AND so.docstatus = 1\r\n          AND so.status NOT IN ('Completed','Closed')\r\n          AND soi.qty > soi.delivered_qty\r\n        \"\"\",\r\n        (item_code,)\r\n    )[0][0]\r\n\r\n    # ------------------------------\r\n    # ITEM HEADER ROW\r\n    # ------------------------------\r\n    row = empty_row()\r\n    row.update({\r\n        \"row_type\": f\"<b>ITEM: {item.item_code}</b>\",\r\n        \"document\": f\"<b>{item.item_name}</b>\",\r\n        \"stock\": stock_qty,\r\n        \"on_quote\": quote_qty,\r\n        \"on_so\": so_qty\r\n    })\r\n    data.append(row)\r\n\r\n    # Spacer\r\n    data.append(empty_row())\r\n\r\n    # ------------------------------\r\n    # INBOUND HISTORY\r\n    # ------------------------------\r\n    row = empty_row()\r\n    row[\"row_type\"] = \"<b>INBOUND HISTORY</b>\"\r\n    data.append(row)\r\n\r\n    inbound = frappe.db.sql(\r\n        \"\"\"\r\n        SELECT pr.name, pr.posting_date, pr.supplier, pri.qty, pri.purchase_order, pr.remarks\r\n        FROM `tabPurchase Receipt Item` pri\r\n        INNER JOIN `tabPurchase Receipt` pr ON pr.name = pri.parent\r\n        WHERE pri.item_code = %s AND pr.docstatus = 1\r\n        ORDER BY pr.posting_date DESC, pr.name DESC\r\n        \"\"\",\r\n        (item_code,),\r\n        as_dict=True\r\n    )\r\n\r\n    if inbound:\r\n        for r in inbound:\r\n            row = empty_row()\r\n            row.update({\r\n                \"row_type\": \"Inbound\",\r\n                \"date\": r.posting_date,\r\n                \"document\": f'<a href=\"/app/purchase-receipt/{r.name}\">{r.name}</a>',\r\n                \"qty\": r.qty,\r\n                \"party\": r.supplier,\r\n                \"reference\": r.purchase_order or \"\",\r\n                \"notes\": r.remarks or \"\"\r\n            })\r\n            data.append(row)\r\n    else:\r\n        row = empty_row()\r\n        row[\"row_type\"] = \"No inbound history\"\r\n        data.append(row)\r\n\r\n    # Spacer\r\n    data.append(empty_row())\r\n\r\n    # ------------------------------\r\n    # OUTBOUND HISTORY\r\n    # ------------------------------\r\n    row = empty_row()\r\n    row[\"row_type\"] = \"<b>OUTBOUND HISTORY</b>\"\r\n    data.append(row)\r\n\r\n    outbound = frappe.db.sql(\r\n        \"\"\"\r\n        SELECT dn.name, dn.posting_date, dn.customer, dni.qty,\r\n               dni.against_sales_invoice, dn.lr_no\r\n        FROM `tabDelivery Note Item` dni\r\n        INNER JOIN `tabDelivery Note` dn ON dn.name = dni.parent\r\n        WHERE dni.item_code = %s AND dn.docstatus = 1\r\n        ORDER BY dn.posting_date DESC, dn.name DESC\r\n        \"\"\",\r\n        (item_code,),\r\n        as_dict=True\r\n    )\r\n\r\n    if outbound:\r\n        for d in outbound:\r\n            row = empty_row()\r\n            row.update({\r\n                \"row_type\": \"Outbound\",\r\n                \"date\": d.posting_date,\r\n                \"document\": f'<a href=\"/app/delivery-note/{d.name}\">{d.name}</a>',\r\n                \"qty\": d.qty,\r\n                \"party\": d.customer,\r\n                \"reference\": d.against_sales_invoice or \"\",\r\n                \"notes\": d.lr_no or \"\"\r\n            })\r\n            data.append(row)\r\n    else:\r\n        row = empty_row()\r\n        row[\"row_type\"] = \"No outbound history\"\r\n        data.append(row)\r\n\r\n    return columns, data\r\n",
 "javascript": null,
 "json": null,
 "doctype": "Report",
 "filters": [
  {
   "name": "1f61jmv80b",
   "owner": "gary.starr@surgishop.com",
   "creation": "2025-12-18 11:31:53.677278",
   "modified": "2025-12-18 11:54:53.961165",
   "modified_by": "gary.starr@surgishop.com",
   "docstatus": 0,
   "idx": 1,
   "label": "Item ",
   "fieldtype": "Link",
   "fieldname": "item_code",
   "mandatory": 1,
   "wildcard_filter": 0,
   "options": "Item",
   "default": "1951B",
   "parent": "Item Tracking Report",
   "parentfield": "filters",
   "parenttype": "Report",
   "doctype": "Report Filter"
  }
 ],
 "roles": [
  {
   "name": "1f61rj5h3u",
   "owner": "gary.starr@surgishop.com",
   "creation": "2025-12-18 11:31:53.677278",
   "modified": "2025-12-18 11:54:53.961165",
   "modified_by": "gary.starr@surgishop.com",
   "docstatus": 0,
   "idx": 1,
   "role": "Desk User",
   "parent": "Item Tracking Report",
   "parentfield": "roles",
   "parenttype": "Report",
   "doctype": "Has Role"
  },
  {
   "name": "1f61qds4ev",
   "owner": "gary.starr@surgishop.com",
   "creation": "2025-12-18 11:31:53.677278",
   "modified": "2025-12-18 11:54:53.961165",
   "modified_by": "gary.starr@surgishop.com",
   "docstatus": 0,
   "idx": 2,
   "role": "Stock Manager",
   "parent": "Item Tracking Report",
   "parentfield": "roles",
   "parenttype": "Report",
   "doctype": "Has Role"
  },
  {
   "name": "1f61gq41t4",
   "owner": "gary.starr@surgishop.com",
   "creation": "2025-12-18 11:31:53.677278",
   "modified": "2025-12-18 11:54:53.961165",
   "modified_by": "gary.starr@surgishop.com",
   "docstatus": 0,
   "idx": 3,
   "role": "Item Manager",
   "parent": "Item Tracking Report",
   "parentfield": "roles",
   "parenttype": "Report",
   "doctype": "Has Role"
  },
  {
   "name": "1f61v8fm02",
   "owner": "gary.starr@surgishop.com",
   "creation": "2025-12-18 11:31:53.677278",
   "modified": "2025-12-18 11:54:53.961165",
   "modified_by": "gary.starr@surgishop.com",
   "docstatus": 0,
   "idx": 4,
   "role": "Manufacturing User",
   "parent": "Item Tracking Report",
   "parentfield": "roles",
   "parenttype": "Report",
   "doctype": "Has Role"
  },
  {
   "name": "1f615eliub",
   "owner": "gary.starr@surgishop.com",
   "creation": "2025-12-18 11:31:53.677278",
   "modified": "2025-12-18 11:54:53.961165",
   "modified_by": "gary.starr@surgishop.com",
   "docstatus": 0,
   "idx": 5,
   "role": "Purchase User",
   "parent": "Item Tracking Report",
   "parentfield": "roles",
   "parenttype": "Report",
   "doctype": "Has Role"
  },
  {
   "name": "1f618k1u7k",
   "owner": "gary.starr@surgishop.com",
   "creation": "2025-12-18 11:31:53.677278",
   "modified": "2025-12-18 11:54:53.961165",
   "modified_by": "gary.starr@surgishop.com",
   "docstatus": 0,
   "idx": 6,
   "role": "Accounts User",
   "parent": "Item Tracking Report",
   "parentfield": "roles",
   "parenttype": "Report",
   "doctype": "Has Role"
  },
  {
   "name": "1f610unp08",
   "owner": "gary.starr@surgishop.com",
   "creation": "2025-12-18 11:31:53.677278",
   "modified": "2025-12-18 11:54:53.961165",
   "modified_by": "gary.starr@surgishop.com",
   "docstatus": 0,
   "idx": 7,
   "role": "Stock User",
   "parent": "Item Tracking Report",
   "parentfield": "roles",
   "parenttype": "Report",
   "doctype": "Has Role"
  },
  {
   "name": "1f616cmvss",
   "owner": "gary.starr@surgishop.com",
   "creation": "2025-12-18 11:31:53.677278",
   "modified": "2025-12-18 11:54:53.961165",
   "modified_by": "gary.starr@surgishop.com",
   "docstatus": 0,
   "idx": 8,
   "role": "Maintenance User",
   "parent": "Item Tracking Report",
   "parentfield": "roles",
   "parenttype": "Report",
   "doctype": "Has Role"
  },
  {
   "name": "1f61iqn0oi",
   "owner": "gary.starr@surgishop.com",
   "creation": "2025-12-18 11:31:53.677278",
   "modified": "2025-12-18 11:54:53.961165",
   "modified_by": "gary.starr@surgishop.com",
   "docstatus": 0,
   "idx": 9,
   "role": "Sales User",
   "parent": "Item Tracking Report",
   "parentfield": "roles",
   "parenttype": "Report",
   "doctype": "Has Role"
  },
  {
   "name": "1f6184ic81",
   "owner": "gary.starr@surgishop.com",
   "creation": "2025-12-18 11:31:53.677278",
   "modified": "2025-12-18 11:54:53.961165",
   "modified_by": "gary.starr@surgishop.com",
   "docstatus": 0,
   "idx": 10,
   "role": "System Manager",
   "parent": "Item Tracking Report",
   "parentfield": "roles",
   "parenttype": "Report",
   "doctype": "Has Role"
  }
 ],
 "columns": []
}